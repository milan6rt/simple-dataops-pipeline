# Simple Azure SQL Database Deployment Pipeline
# Only 2 files: this YAML + SQL script

trigger:
- main

pool:
  name: 'Default'  # Your existing Mac agent

variables:
  sqlServerName: 'sqlserver-dataops-demo-milan.database.windows.net'
  databaseName: 'db-employees-demo'

jobs:
- job: DeployCustomersTable
  displayName: 'Deploy Customers Table'
  steps:
  
  - checkout: self
    displayName: 'ğŸ“¥ Get SQL files from GitHub'
  
  - script: |
      echo "ğŸ” Files to deploy:"
      ls -la sql/
      echo ""
      echo "ğŸ“„ SQL Content:"
      cat sql/create_customers_table.sql
    displayName: 'ğŸ” Show SQL Content'
  
  - script: |
      echo "ğŸ“¦ Installing pymssql..."
      pip3 install pymssql
      echo "âœ… Dependencies ready"
    displayName: 'ğŸ“¦ Install Dependencies'
  
  - script: |
      echo "ğŸš€ Deploying SQL changes..."
      
      python3 << 'EOF'
      import pymssql
      import sys
      
      # Connection details
      server = '$(sqlServerName)'
      database = '$(databaseName)'
      username = '$(sqlUsername)'
      password = '$(sqlPassword)'
      
      try:
          print(f"ğŸ“¡ Connecting to: {server}")
          print(f"ğŸ“Š Database: {database}")
          
          # Read SQL file
          with open('sql/create_customers_table.sql', 'r') as file:
              sql_script = file.read()
          
          print("ğŸ“œ Executing SQL script...")
          
          # Connect and execute
          conn = pymssql.connect(
              server=server,
              user=username,
              password=password,
              database=database,
              timeout=30
          )
          
          cursor = conn.cursor()
          cursor.execute(sql_script)
          conn.commit()
          
          print("âœ… SQL script executed successfully!")
          
          # Verify the table was created
          cursor.execute("SELECT COUNT(*) FROM customers")
          count = cursor.fetchone()[0]
          print(f"ğŸ“Š Customers table now has {count} records")
          
          conn.close()
          print("ğŸ‰ Deployment completed successfully!")
          
      except Exception as e:
          print(f"âŒ Deployment failed: {str(e)}")
          sys.exit(1)
      EOF
    displayName: 'ğŸš€ Deploy SQL Changes'
